<?php
http_response_code(401);
$json_str = file_get_contents('php://input');
$_POST = json_decode($json_str,true);
//проверка, что все данные пришли,дальше проверка hash_ver.  

if(isset($_POST['login']) and isset($_POST['hash_verify'])){
	# Вытаскиваем из БД запись, у которой логин равняеться введенному
	$login = htmlspecialchars(strip_tags(trim($_POST['login'])), ENT_QUOTES | ENT_SUBSTITUTE | ENT_HTML5);
	$login = mysqli_real_escape_string($login));
	$hash_ver = $_POST['hash_verify'];
	$data_apcu = apcu_fetch($login + "_" + $hash_ver);
	$ttl = 120;
	// $isStored = apcu_store($login + "_" + $hash_ver, ['password' => $trial, "salt" => $salt_key], $ttl)
	if ($data_apcu) {
		if($data_apcu['password']){
			if((strlen($login) > 4)){
				require_once "db.php"; 
				$sql = "SELECT `password`,`2fa`,`code` FROM `users` WHERE login= ? LIMIT 1";
				$stmt = mysqli_prepare($link, $sql);
				mysqli_stmt_bind_param($stmt, 's', $login);
				//$query = mysqli_query($link,);
				//использование плейсходера.
				mysqli_stmt_execute($stmt);
				$result = mysqli_stmt_get_result($stmt);
				//$query = mysqli_query($link,"SELECT * FROM `user` WHERE login='".trim($_POST['login'])."' LIMIT 1");
				$data = mysqli_fetch_assoc($result);
				$hash_ver = hash('sha3-512', $login.$data['password'].$data_apcu['salt']);
				//удалить все данные по прошлому хэшу, и сохранить новые данные
				if (($hash_ver === $_POST['hash_verify']) and (GetIP() == $data_apcu['ip'])){
					$code = $data['code'];
					if ($data['2fa']){
						$auth_code = rand(10000000,99999999);
						$isStored = apcu_store($login."_".$hash_ver, ['auth_code' => $auth_code, 'ip' => $data_apcu['ip']], $ttl);
						http_response_code(200);
						switch ($data['2fa']) {
							case 'email':
								require 'phpmailer/PHPMailer.php';
								require 'phpmailer/SMTP.php';
								require 'phpmailer/Exception.php';
								$mail = new PHPMailer\PHPMailer\PHPMailer();
								try {
								    $mail->isSMTP();   
								    $mail->CharSet = "UTF-8";
								    $mail->SMTPAuth   = true;
								    $mail->SMTPDebug = 2;
								    $mail->Debugoutput = function($str, $level) {$GLOBALS['status'][] = $str;};

								    // Настройки вашей почты
								    $mail->Host       = 'smtp.yandex.ru'; // SMTP сервера вашей почты
								    $mail->Username   = 'devops@web-gen.ru'; // Логин на почте
								    $mail->Password   = 'kuwjjqbxuwmtcwvi'; // Пароль на почте
								    $mail->SMTPSecure = 'ssl';
								    $mail->Port       = 465;
								    $mail->setFrom('devops@web-gen.ru', 'WEB-GEN'); // Адрес самой почты и имя отправителя
								    $mail->DKIM_domain = 'web-gen.ru';
								    $mail->DKIM_public = '../../../../key/public.pem';
								    $mail->DKIM_selector = 'mail';
								    $mail->DKIM_passphrase = '';
								    $mail->DKIM_identity = $mail->From;

								    // Получатель письма
								    $mail->addAddress('mr.dany2003@mail.ru');  
								    //$mail->addAddress(''); // Ещё один, если нужен

								// Отправка сообщения
								$mail->Subject = "Код";
								$mail->Body = $auth_code;    

								// Проверяем отравленность сообщения
								if ($mail->send()) {$result = "success";} 
								else {$result = "error";}

								} catch (Exception $e) {
								    http_response_code(404);
								}
								break;
							case 'whatsapp':
								$number = "79780346375";
								$wa_idInstance = '1101758210';
								$wa_apiTokenInstance = '2453a7b90fb14451bae6fc847e64b2d100fd3f23205e4e648d';	
								$datap = array(
									"phoneNumber" => $number
								);	
								$ch = curl_init('https://api.green-api.com/waInstance'.$wa_idInstance.'/CheckWhatsapp/'.$wa_apiTokenInstance);
								curl_setopt($ch, CURLOPT_HTTPHEADER, array('Content-Type:application/json'));
								curl_setopt($ch, CURLOPT_POST, 1);
								curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($datap, JSON_UNESCAPED_UNICODE)); 
								curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
								curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
								curl_setopt($ch, CURLOPT_HEADER, false);
								$res = curl_exec($ch);
								curl_close($ch);
								$res = json_decode($res, true);
								if($res['existsWhatsapp']){
									$data = array(
										"chatId"=> $number."@c.us",
										"message"=> $auth_code 
									);		
									$ch = curl_init('https://api.green-api.com/waInstance'.$wa_idInstance.'/SendMessage/'.$wa_apiTokenInstance);
									curl_setopt($ch, CURLOPT_HTTPHEADER, array('Content-Type:application/json'));
									curl_setopt($ch, CURLOPT_POST, 1);
									curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data, JSON_UNESCAPED_UNICODE)); 
									curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
									curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
									curl_setopt($ch, CURLOPT_HEADER, false);
									$res = curl_exec($ch);
									curl_close($ch);
									http_response_code(200);
									exit;
								}
								break;
						}
						echo $hash_ver;
						//отправка письма с кодом авторизации на почту,телефон, мобильное приложение. Короче, вторая аутендефикация 
						//здесь ответ 200 + json с хэшем и id.этот хэш, ключ для apcu где лежит код из двухфакторки
					}
					else{ 
						http_response_code(200);
						echo $code;
						//переадресация на token.generation.php?code=$code&login=$login&hash=$hash_ver

					}
				}
			}
		}
	}
}
function GetIP() {
  if (!empty($_SERVER['HTTP_CLIENT_IP'])) {
    $ip = $_SERVER['HTTP_CLIENT_IP'];
  } elseif (!empty($_SERVER['HTTP_X_FORWARDED_FOR'])) {
    $ip = $_SERVER['HTTP_X_FORWARDED_FOR'];
  } else {
    $ip = $_SERVER['REMOTE_ADDR'];
  }
  return $ip;
}
?>